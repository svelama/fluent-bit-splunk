---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: logging
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush        5
        Daemon       Off
        Log_Level    info
        Parsers_File parsers.conf

    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        Parser            docker
        Tag               kube.*
        Refresh_Interval  5
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On

    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Keep_Log            Off
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On
        Labels              On
        Annotations         Off

    # Exclude Fluent Bit's own logs to prevent recursive processing
    [FILTER]
        Name    grep
        Match   kube.*
        Exclude kubernetes.namespace_name logging

    # Add metadata field to determine routing
    [FILTER]
        Name    lua
        Match   kube.*
        script  /fluent-bit/scripts/retag_logs.lua
        call    retag_by_label_and_container

    # Re-tag: consumer-logs (pod has label "consumer-splunk-index" AND container name is "app")
    [FILTER]
        Name                rewrite_tag
        Match               kube.*
        Rule                $_log_type ^consumer$ consumer-logs true
        Emitter_Name        re_emitted_consumer

    # Re-tag: tdp-infra (all other logs)
    [FILTER]
        Name                rewrite_tag
        Match               kube.*
        Rule                $_log_type ^infrastructure$ tdp-infra true
        Emitter_Name        re_emitted_infra

    # Filter: Enrich consumer logs with Splunk token from secrets
    # Note: splunk_index is already set by retag_logs.lua from pod label
    [FILTER]
        Name    lua
        Match   consumer-logs
        script  /fluent-bit/scripts/enrich_splunk.lua
        call    enrich_with_splunk_config

    # Filter: Enrich infrastructure logs with static Splunk index and token
    [FILTER]
        Name    modify
        Match   tdp-infra
        Add     splunk_index tdp-infrastructure-index
        Add     splunk_token INFRA-TOKEN-STATIC

    # Output to stdout for debugging
    [OUTPUT]
        Name   stdout
        Match  *
        Format json_lines

    # Output: Consumer logs to Splunk (with dynamic index from label)
    [OUTPUT]
        Name        http
        Match       consumer-logs
        Host        mock-splunk-consumer.splunk-mock.svc.cluster.local
        Port        8088
        URI         /services/collector/event
        Format      json
        Header      Authorization Splunk ${splunk_token}
        json_date_key timestamp
        json_date_format iso8601

    # Output: TDP Infrastructure logs to separate Splunk instance
    [OUTPUT]
        Name        http
        Match       tdp-infra
        Host        mock-splunk-infra.splunk-mock.svc.cluster.local
        Port        8088
        URI         /services/collector/event
        Format      json
        Header      Authorization Splunk INFRA-TOKEN-STATIC
        json_date_key timestamp
        json_date_format iso8601

  parsers.conf: |
    [PARSER]
        Name   docker
        Format json
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep On
